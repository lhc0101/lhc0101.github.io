<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.9.0">
<meta name="referrer" content="no-referrer"/>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.min.css">
  <script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"xchcloud.cn","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"always","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":{"valine":{"text":"Load Disqus","order":-1}}},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="八个特性速度快数据存在内存上用 C 语言写的线程模型是单线程 持久化断电不丢数据所有数据保存在内存中，对数据的更新将异步地保存到磁盘中">
<meta name="keywords" content="Redis">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis-入门笔记">
<meta property="og:url" content="https://xchcloud.cn/Redis-入门笔记/index.html">
<meta property="og:site_name" content="chaoz的杂货铺">
<meta property="og:description" content="八个特性速度快数据存在内存上用 C 语言写的线程模型是单线程 持久化断电不丢数据所有数据保存在内存中，对数据的更新将异步地保存到磁盘中">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2021-09-11T09:01:23.607Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Redis-入门笔记">
<meta name="twitter:description" content="八个特性速度快数据存在内存上用 C 语言写的线程模型是单线程 持久化断电不丢数据所有数据保存在内存中，对数据的更新将异步地保存到磁盘中">

<link rel="canonical" href="https://xchcloud.cn/Redis-入门笔记/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Redis-入门笔记 | chaoz的杂货铺</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">chaoz的杂货铺</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">生命有息、学无止境、折腾不止</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://xchcloud.cn/Redis-入门笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="超超">
      <meta itemprop="description" content="那天早上雾散了，不止早上、不止雾。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="chaoz的杂货铺">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis-入门笔记
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-06 17:17:16" itemprop="dateCreated datePublished" datetime="2020-02-06T17:17:16+08:00">2020-02-06</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-09-11 17:01:23" itemprop="dateModified" datetime="2021-09-11T17:01:23+08:00">2021-09-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
            </span>

          
            <span id="/Redis-入门笔记/" class="post-meta-item leancloud_visitors" data-flag-title="Redis-入门笔记" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/Redis-入门笔记/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/Redis-入门笔记/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>12 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="八个特性"><a href="#八个特性" class="headerlink" title="八个特性"></a>八个特性</h2><h3 id="速度快"><a href="#速度快" class="headerlink" title="速度快"></a>速度快</h3><p>数据存在内存上<br>用 C 语言写的<br>线程模型是单线程</p>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p>断电不丢数据<br>所有数据保存在内存中，对数据的更新将异步地保存到磁盘中<br><a id="more"></a></p>
<h3 id="多种数据结构"><a href="#多种数据结构" class="headerlink" title="多种数据结构"></a>多种数据结构</h3><p><img data-src="http://tuchuang.xchcloud.cn/数据结构图.png" alt="图一"></p>
<p>其他：</p>
<p>BitMaps：位图<br>HyperLogLog：超小内存唯一数值<br>GEO：地理信息定位</p>
<h3 id="支持多种编程语言"><a href="#支持多种编程语言" class="headerlink" title="支持多种编程语言"></a>支持多种编程语言</h3><h3 id="功能丰富"><a href="#功能丰富" class="headerlink" title="功能丰富"></a>功能丰富</h3><p>发布订阅</p>
<p>事务</p>
<p>Lua 脚本</p>
<p>pipeline</p>
<h3 id="简单"><a href="#简单" class="headerlink" title="简单"></a>简单</h3><p>只有 23000 行 C 代码：单机的</p>
<p>不依赖外部库</p>
<p>单线程模型</p>
<h3 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h3><p>高可用、分布式</p>
<h3 id="高可用、分布式"><a href="#高可用、分布式" class="headerlink" title="高可用、分布式"></a>高可用、分布式</h3><p>Redis-Sentinel（v2.8）支持高可用</p>
<p>Redis-Cluster（v3.0）支持分布式</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><h3 id="缓存系统"><a href="#缓存系统" class="headerlink" title="缓存系统"></a>缓存系统</h3><p><img data-src="http://tuchuang.xchcloud.cn/缓存图二.png" alt="图二"></p>
<h3 id="计数器"><a href="#计数器" class="headerlink" title="计数器"></a>计数器</h3><p><img data-src="http://tuchuang.xchcloud.cn/计数器图三.png" alt="图三"></p>
<h3 id="消息队列系统"><a href="#消息队列系统" class="headerlink" title="消息队列系统"></a>消息队列系统</h3><p><img data-src="http://tuchuang.xchcloud.cn/消息队列图四.png" alt="图四"></p>
<h3 id="排行榜"><a href="#排行榜" class="headerlink" title="排行榜"></a>排行榜</h3><h3 id="社交网络"><a href="#社交网络" class="headerlink" title="社交网络"></a>社交网络</h3><p>粉丝数、关注数、共同关注</p>
<h3 id="实时系统"><a href="#实时系统" class="headerlink" title="实时系统"></a>实时系统</h3><p>垃圾邮件过滤</p>
<h2 id="redis-安装"><a href="#redis-安装" class="headerlink" title="redis 安装"></a>redis 安装</h2><p>安装、可执行文件说明、三种启动方法、简单的客户端连接</p>
<p>redis-server RRedis服务器<br>redis-cli redis 命令行客户端<br>redis-benchmark redis 性能测试工具<br>redis-check-aof AOF文件修复工具<br>redis-check-dump RDB文件检查工具<br>redis-sentinel Sentinel服务器（2.8以后）</p>
<p>三种启动方法：</p>
<p>最简启动</p>
<p>动态参数启动<br>redis-server –port 6380</p>
<p>配置文件启动<br>redis-server configPath</p>
<p>三种启动方式比较：<br>生成环境选择配置启动<br>单机多实例配置文件可以用端口区分开</p>
<p>redis 客户端链接<br>redis-cli -h 10.10.19.150 -p 6384<br>10.10.79.150:6384&gt; ping<br>PONG<br>10.10.79.150:6384&gt; set hello world<br>“OK”<br>10.10.79.150:6384&gt;get hello<br>“world”</p>
<p>redis 客户端返回值<br>状态回复<br>错误回复<br>整数回复<br>字符串回复<br>多行字符串回复</p>
<p>验证是否启动</p>
<p>ps -ef | grep redis<br>netstat -antpl | grep redis<br>redis-cli -h ip -p port ping</p>
<p>redis 常用配置：<br>daemonize：是否守护进程<br>port：redis 对外端口<br>logfile：redis 系统日志<br>dir：redis 工作目录<br>RDB config<br>AOF config<br>slow Log config<br>maxMemory</p>
<h2 id="通用命令"><a href="#通用命令" class="headerlink" title="通用命令"></a>通用命令</h2><h3 id="通用命令-1"><a href="#通用命令-1" class="headerlink" title="通用命令"></a>通用命令</h3><p>keys</p>
<p>dbsize</p>
<p>exists key</p>
<p>del key [key ….]</p>
<p>expire key seconds :key在secends卖弄之后过期<br>ttl key ：查看key剩余的过期时间<br>persist key ：去掉key的过期时间</p>
<p>返回值 0 -1：代表key存在，并且没有过期时间 -2：代表不存在了</p>
<p>type key ：返回 key 的类型<br>string、hash、list、set、zset、none</p>
<p>incr key：key自增1，如果key不存在，自增后get(key)=1 O(1)<br>decr key：key自减1，如果key不存在，自减后get(key)=1 O(1)<br>incrby key k：key自增k，如果key不存在，自增后get(key)=k O(1)<br>decr key k：key自减k，如果key不存在，自减后get(key)=k O(1)</p>
<p>set key value ： 不管 key 是否存在，都设置 O(1)<br>setnx key value ：key 不存在，才设置 O(1)<br>set key value xx : key存在，才设置 O(1)</p>
<p>mget key1 key2 key3 …..  O(n)<br>mset key1 value1 key2 value2 key3 value3 O(n)<br>n 次 get = n 次网络时间 + n 次命令时间；这里用 mget 的话能省去大量的时间</p>
<p>getset key newvalue : set key newvalue 并返回旧的 value O(1)<br>append key value : 将 value 追加到旧的 value  O(1)<br>strlen key 返回字符串的长度（注意中文） O(1)</p>
<p>incrbyfloat key 3.5 ： 增加 key 对应的值3.5<br>getrange key start end ： 获取字符串指定下标所有的值<br>setrange key index value : 设置指定下标所有对应的值</p>
<h3 id="时间复杂度"><a href="#时间复杂度" class="headerlink" title="时间复杂度"></a>时间复杂度</h3><p><img data-src="http://tuchuang.xchcloud.cn/时间复杂度图五.png" alt="图五"></p>
<h3 id="数据结构和内部编码"><a href="#数据结构和内部编码" class="headerlink" title="数据结构和内部编码"></a>数据结构和内部编码</h3><p><img data-src="http://tuchuang.xchcloud.cn/数据结构和内部编码图六.png" alt="图六"></p>
<p>redisObject<br><img data-src="http://tuchuang.xchcloud.cn/redisobject%20%E5%9B%BE%E4%B8%83.png" alt="图七"></p>
<h3 id="单线程"><a href="#单线程" class="headerlink" title="单线程"></a>单线程</h3><p>一瞬间只执行一个命令</p>
<p>为什么还是快：<br>纯内存；非阻塞 IO；避免线程切换和静态消耗</p>
<p>使用单线程时要注意什么：<br>一次只能用一条命令；<br>拒绝长命令：在应用中，高可用别这么用，会卡导致超时</p>
<h3 id="字符串键值结构"><a href="#字符串键值结构" class="headerlink" title="字符串键值结构"></a>字符串键值结构</h3><p><img data-src="http://tuchuang.xchcloud.cn/字符串总结图九.png" alt="图八"></p>
<h3 id="字符串总结"><a href="#字符串总结" class="headerlink" title="字符串总结"></a>字符串总结</h3><p><img data-src="http://tuchuang.xchcloud.cn/字符串总结图九.png" alt="图九"></p>
<h3 id="redis-Api-的使用和理解"><a href="#redis-Api-的使用和理解" class="headerlink" title="redis Api 的使用和理解"></a>redis Api 的使用和理解</h3><p>哈希：</p>
<p>特点<br>重要 API</p>
<p>hash vs string</p>
<p>查缺补漏</p>
<p><img data-src="http://tuchuang.xchcloud.cn/hash%20%E9%94%AE%E5%80%BC%E7%BB%93%E6%9E%84%E5%9B%BE10.png" alt="图十"><br><img data-src="http://tuchuang.xchcloud.cn/图11.png" alt="图11"></p>
<p>hget key field : 获取 hash key 对应的 file 的 value O(1)<br>hset key field value ：设置 hash key 对应的 value O(1)<br>hdel key field ： 删除 hash key 对应 field 的 value O(1)</p>
<p>hexists key field : 判断 hash key 是否有 field  O(1)<br>hlen key ： 获取 hash key field 的数量  O(1)</p>
<p>hmget key field1 field2 … fieldN : 批量获取 hash key 的一批 field 对应的值 O(n)<br>hmset key field1 value1 field2 value2 … fieldN valueN O(n)</p>
<h2 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h2><p>hincrby user:1:info pageview count</p>
<p>hgetall key : 返回 hash key 对应所有的 field 和 value O(n)<br>hvals key ：返回 hash key 对应所有 field 的 value O(n)<br>hkeys key ： 返回 hash key 对应所有 field O(n)</p>
<p>小心使用 hgetall ，牢记单线程，会比较慢</p>
<p>如何更新用户属性？<br>string 实现2种，hash</p>
<p><img data-src="http://tuchuang.xchcloud.cn/有序集合总结图十三.png" alt="图十二"></p>
<p>列表结构：<br>有序、可以重复、数据结构一样左右两边插入弹出</p>
<p>rpush key value1 value2 … valueN : 从列表右端插入 O(1~n)<br>lpush key value1 value2 … valueN : 从列表左端插入 O(1~n)  </p>
<p>linsert key before|after value newvalue : 在 list 指定的值前|后插入newvalue O(n)</p>
<p>lpop key : 从列表左侧弹出一个item O(1)<br>rpop key : 从列表右侧弹出一个item O(1)</p>
<p>lrem key count value : 根据 count 值，从列表中删除所有value相等的项 O(n)<br>（1）count&gt;0,从左到右，删除最多count个value相等的项<br>（2）count&lt;0,从右到左，删除最多Math.abs(count)个value相等的项<br>（3）count=0，删除所有value相等的项</p>
<p>ltrim key start end : 按照索引范围修剪列表 O(n)<br>lrange key start end (包含end) : 获取列表指定索引范围所有item O(n)<br>lindex key index : 获取列表指定索引的item O(n)<br>llen key ： 获取列表长度<br>lset lset key index newvalue : 设置列表指定索引值为 newvalue O(n)</p>
<p>blpop key timeout : lpop 阻塞版本，timeout 时阻塞超时时间，timout=0为永远不阻塞。  O(1)<br>brpop key timeout : rpop 阻塞版本，timeout 时阻塞超时时间，timout=0为永远不阻塞。  O(1)</p>
<p>TIPS<br>1、LRUSH + LPOP = Stack<br>2、LPUSH + RPOP =Queue<br>3、LPUSH + LTRIM =Capped Collection<br>4、LPUSH + BRPOP = Message Queue</p>
<p>sadd key element : 向集合 key 添加 element （如果 element 已经存在，添加失败）<br>srem key element : 将集合key中的element移除掉</p>
<p>scard user:1:follow = 4 :计算集合大小<br>sismember user:1follow it = 1 : 判断it是否在集合中<br>srandmember user:1:follow count = his :从集合中随机挑 count 个元素   不改变<br>spop user:1:follow = sports :从集合中随机弹出一个元素   改变原来的<br>smember user:1:follow = music his sports it :获取集合所有元素  无序的，小心使用</p>
<p>集合间 API </p>
<p>sdiff user:1:follow user:2:follow = music his : 差集<br>sinter user:1:follow user:2:follow = it sports : 交集<br>sunion user:1:follow user:2:follow = it music his sports news ent ： 并集<br>sdiff|sinter|suion + store destkey .. 将差集、交集、并集结果保存在destkey中</p>
<p>有序集合：<br>无重复元素、有序<br>api 都是以 z 开头<br>zadd key score element(可以是多对) ： 添加score和element  O(logN)<br>zrem key element(可以是多个) ： 删除元素  O(1)<br>zscore key element : 返回元素的分数</p>
<p>zincrby key increScore element : 增加或者减少元素分数 O(1)<br>zcard key : 返回元素总个数 O(1)</p>
<p>zrange key start end [WITHSCORES] : 返回指定索引范围内的升序元素[分值] o(log(n)+m)<br>zrangebyscore key minScore maxScore [WITHSCORES] : 返回指定分数范围内的升序元素[分值] o(log(n)+m)<br>zcount key minScore maxScore ；返回有序集合内在指定分数范围内的个数  o(log(n)+m)</p>
<p>zremrangebyrank key start end : 删除指定排名内的升序元素  o(log(n)+m)</p>
<p>zrevrank<br>zrevrange<br>zrevrangebyscore<br>zinterstore<br>zunionstore</p>
<p><img data-src="http://tuchuang.xchcloud.cn/有序集合总结图十三.png" alt="有序集合总结图十三"></p>
<h2 id="redis-客户端"><a href="#redis-客户端" class="headerlink" title="redis 客户端"></a>redis 客户端</h2><h3 id="java-客户端-：Jedis"><a href="#java-客户端-：Jedis" class="headerlink" title="java 客户端 ：Jedis"></a>java 客户端 ：Jedis</h3><p>直连：</p>
<p>连接池：</p>
<p>问题：池子里有多少个连接合适呢</p>
<p>两种方案对比：</p>
<p><img data-src="http://tuchuang.xchcloud.cn/直连与连接池对比图十四.png" alt="图十四"></p>
<h3 id="python-客户端-：redis-py"><a href="#python-客户端-：redis-py" class="headerlink" title="python 客户端 ：redis-py"></a>python 客户端 ：redis-py</h3><h2 id="瑞士军刀-redis"><a href="#瑞士军刀-redis" class="headerlink" title="瑞士军刀 redis"></a>瑞士军刀 redis</h2><h3 id="慢查询"><a href="#慢查询" class="headerlink" title="慢查询"></a>慢查询</h3><h4 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h4><p><img data-src="http://tuchuang.xchcloud.cn/%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%20%E5%9B%BE%E5%8D%81%E4%BA%94.png" alt="图十五"></p>
<p>注：慢查询发生在第三阶段；客户端超时不一定慢查询，但慢查询是客户端超时的一个可能因素。</p>
<h4 id="两个配置"><a href="#两个配置" class="headerlink" title="两个配置"></a>两个配置</h4><p>slowlog-max-len</p>
<p>1、先进先出队列<br>2、固定长度<br>3、保存在内存中</p>
<p>slowlog-log-slower-than</p>
<p>1、慢查询阈值（单位：微秒）<br>2、slowlog-log-slower-than = 0，记录所有命令<br>3、slowlog-log-slower-than &lt; 0，不记录任何命令</p>
<p>配置方法：</p>
<p>1、默认值：<br>config get slowlog-max-len = 128<br>config get slowlog-log-slower-then = 10000</p>
<p>2、修改配置文件重启</p>
<p>3、动态配置</p>
<p>config set slower-max-len 1000<br>config set slowlog-log-slower-than 1000</p>
<h4 id="三个命令"><a href="#三个命令" class="headerlink" title="三个命令"></a>三个命令</h4><p>1、slowlog get [n]：获取慢查询队列  n 条<br>2、slowlog len ： 获取慢查询队列长度<br>3、slowlog reset ： 清空慢查询队列</p>
<h4 id="运维经验"><a href="#运维经验" class="headerlink" title="运维经验"></a>运维经验</h4><p>1、slowlog-max-len 不要设置太大，默认10ms，通常设置1ms<br>2、slowlog-log-slower-than不要设置过小，通常设置1000左右<br>3、理解命令生命周期<br>4、定期持续化慢查询</p>
<h3 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h3><h4 id="什么是流水线"><a href="#什么是流水线" class="headerlink" title="什么是流水线"></a>什么是流水线</h4><p>将一批命令进行打包并进行计算，然后将结果返回。类似 m*** 操作</p>
<h4 id="与原生操作对比"><a href="#与原生操作对比" class="headerlink" title="与原生操作对比"></a>与原生操作对比</h4><p>一个是原子命令，一个是非原子的命令进行拆分。</p>
<h4 id="客户端实现"><a href="#客户端实现" class="headerlink" title="客户端实现"></a>客户端实现</h4><h4 id="使用建议"><a href="#使用建议" class="headerlink" title="使用建议"></a>使用建议</h4><p>1、注意每次 pipeline 携带数据量<br>2、pipeline 每次只能作用在一个redis节点上<br>3、M操作与pipeline区别</p>
<h3 id="发布订阅"><a href="#发布订阅" class="headerlink" title="发布订阅"></a>发布订阅</h3><h4 id="角色"><a href="#角色" class="headerlink" title="角色"></a>角色</h4><ul>
<li><p>发布者</p>
</li>
<li><p>频道</p>
</li>
<li><p>订阅者</p>
</li>
</ul>
<h4 id="模型"><a href="#模型" class="headerlink" title="模型"></a>模型</h4><p><img data-src="http://tuchuang.xchcloud.cn/%E6%A8%A1%E5%9E%8B%20%E5%9B%BE%E5%8D%81%E5%85%AD.png" alt="图十六"></p>
<h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><ul>
<li>publish 发布命令</li>
</ul>
<p>publish channel message</p>
<ul>
<li>subscribe </li>
</ul>
<p>subscribe [channel] : 一个或者多个</p>
<ul>
<li>unsubscribe</li>
</ul>
<p>unsubscribe [channel] : 取消订阅 一个或者多个</p>
<ul>
<li>其他</li>
</ul>
<p>1、psubscribe [pattern …]  订阅模式<br>2、punsubscribe [pattern …] 退订指定模式<br>3、pubsub channels 列出至少有一个订阅者的频道<br>4、pubsub numsub [channel …] 列出给定频道的订阅者数量<br>5、pubsub numpat 列出被订阅模式的数量</p>
<h4 id="消息队列"><a href="#消息队列" class="headerlink" title="消息队列"></a>消息队列</h4><p><img data-src="http://tuchuang.xchcloud.cn/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%20%E5%9B%BE%E5%8D%81%E4%B8%83.png" alt="图十七"></p>
<h4 id="发布订阅总结"><a href="#发布订阅总结" class="headerlink" title="发布订阅总结"></a>发布订阅总结</h4><p>1、发布订阅模式中的角色<br>2、重要的API<br>3、消息队列和发布订阅</p>
<h3 id="Bitmap"><a href="#Bitmap" class="headerlink" title="Bitmap"></a>Bitmap</h3><h4 id="位图"><a href="#位图" class="headerlink" title="位图"></a>位图</h4><p><img data-src="http://tuchuang.xchcloud.cn/%E4%BD%8D%E5%9B%BE%20%E5%9B%BE%E5%8D%81%E5%85%AB.png" alt="图十八"></p>
<h4 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h4><p>setbit key offset value  :给位图指定索引设置值</p>
<p>没看明白</p>
<p>getbit key offset : 获取位图指定索引的值</p>
<p>bitcount key [start end] : 获取位图指定范围（start到end，单位为字节，如果不指定就是获取全部）位置为1的个数。</p>
<p>bitop op destkey key [key …]<br>做多个 Bitmap 的and（交集）、or（并集）、not（非）、xor（异或）操作并将结果保存在destkey中。</p>
<p>bitpos key targetBit [start][end]<br>计算位图指定范围（start到end，单位为字节，如果不指定就是获取全部）第一个偏移量对应的值等于targetBit的位置</p>
<h4 id="独立用户统计"><a href="#独立用户统计" class="headerlink" title="独立用户统计"></a>独立用户统计</h4><p><img data-src="http://tuchuang.xchcloud.cn/独立用户图十九.png" alt="图十九"></p>
<p>没看懂</p>
<h4 id="使用经验"><a href="#使用经验" class="headerlink" title="使用经验"></a>使用经验</h4><p>1、type = string 最大512M<br>2、注意setbit时的偏移量，可能有较大耗时<br>3、位图不是绝对好</p>
<h3 id="HyperlogLog"><a href="#HyperlogLog" class="headerlink" title="HyperlogLog"></a>HyperlogLog</h3><h4 id="新的数据结构？"><a href="#新的数据结构？" class="headerlink" title="新的数据结构？"></a>新的数据结构？</h4><p>算法：极小的空间来完成独立数量统计</p>
<h4 id="内存消耗"><a href="#内存消耗" class="headerlink" title="内存消耗"></a>内存消耗</h4><p><img data-src="http://tuchuang.xchcloud.cn/内存消耗图二十.png" alt="图二十"></p>
<h4 id="三个命令-1"><a href="#三个命令-1" class="headerlink" title="三个命令"></a>三个命令</h4><p>1、pfadd key element [element …] : 向HyperlogLog添加元素<br>2、pfcount key [key …] : 计算 HyperlogLog 的独立总数<br>3、prmerge destkey sourcekey [sourcekey …] : 合并多个HyperlogLog</p>
<h4 id="使用经验-1"><a href="#使用经验-1" class="headerlink" title="使用经验"></a>使用经验</h4><p>1、是否能容忍错误？（错误率 ： 0.81%）</p>
<p>2、是否需要单条数据</p>
<h3 id="GEO"><a href="#GEO" class="headerlink" title="GEO"></a>GEO</h3><h4 id="是什么？"><a href="#是什么？" class="headerlink" title="是什么？"></a>是什么？</h4><p>地理信息定位: 存储经纬度、计算两地距离、范围计算等</p>
<h4 id="相关命令-1"><a href="#相关命令-1" class="headerlink" title="相关命令"></a>相关命令</h4><p>geo key longitude latitude member [longitude latitude member …] 增加地理位置信息</p>
<p>geopos key member [member …] : 获取地理位置信息</p>
<p>geodist key member1 member2 [unit] : 获取两个地理位置的距离 m米、km、mi英里、ft尺</p>
<p><img data-src="http://tuchuang.xchcloud.cn/georadius图二十.png" alt="georadius图二十"></p>
<h4 id="相关说明"><a href="#相关说明" class="headerlink" title="相关说明"></a>相关说明</h4><p>1、since 3.2<br>2、type geoKey = zset</p>
<h2 id="持久化的取舍和选择"><a href="#持久化的取舍和选择" class="headerlink" title="持久化的取舍和选择"></a>持久化的取舍和选择</h2><h3 id="持续化作用"><a href="#持续化作用" class="headerlink" title="持续化作用"></a>持续化作用</h3><h4 id="什么是持久化"><a href="#什么是持久化" class="headerlink" title="什么是持久化"></a>什么是持久化</h4><p>redis 数据保存在内存中，同时将数据的更新异步的保存到磁盘上</p>
<h4 id="持久化的实现方式"><a href="#持久化的实现方式" class="headerlink" title="持久化的实现方式"></a>持久化的实现方式</h4><p>快照：mysql dump  ； redis rdb</p>
<p>写日志 ： mysql binlog ； hbase hlog ；redis aof</p>
<h3 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h3><h4 id="什么是-RDB"><a href="#什么是-RDB" class="headerlink" title="什么是 RDB"></a>什么是 RDB</h4><p>RDB 文件 是一个二进制文件，存储在硬盘中，内存写入磁盘，重启从磁盘载入恢复，以及主从方式的媒介。</p>
<h4 id="触发机制-主要三种方式"><a href="#触发机制-主要三种方式" class="headerlink" title="触发机制-主要三种方式"></a>触发机制-主要三种方式</h4><p>同步、异步、自动。</p>
<p>save 命令</p>
<p>bgsave 命令 ： 子进程用来生成RDB文件，不会出现阻塞</p>
<p>自动生成 ： 满足一定条件，就去写一个RDB文件</p>
<p>配置：</p>
<p>dbfilename dump-${port}.rdb<br>dir /bigdiskpath<br>stop-write-on-bgsave-error yes<br>rdbcompression yes<br>rdbchecksum yes</p>
<h4 id="触发机制-不容忽视方式"><a href="#触发机制-不容忽视方式" class="headerlink" title="触发机制-不容忽视方式"></a>触发机制-不容忽视方式</h4><p>1、全量复制</p>
<p>2、debug reload  不清内存的重启</p>
<p>3、shutdown</p>
<h4 id="RDB-总结"><a href="#RDB-总结" class="headerlink" title="RDB 总结"></a>RDB 总结</h4><p>1、RDB 是 Redis 内存到硬盘的快照，用于持久化<br>2、sava通常会阻塞Redis<br>3、bgsave 不会阻塞Redis，但是会fork新进程<br>4、save 自动配置满足人亦就会被执行<br>5、有些触发机制不容忽视</p>
<h4 id="redis-配置文件说明"><a href="#redis-配置文件说明" class="headerlink" title="redis 配置文件说明"></a>redis 配置文件说明</h4><h3 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h3><h4 id="RDB-现存的问题"><a href="#RDB-现存的问题" class="headerlink" title="RDB 现存的问题"></a>RDB 现存的问题</h4><p>耗时、耗性能：O(n)数据，耗时；fork 消耗内存，copy-on-write 策略；Disk I/O</p>
<h4 id="什么是-AOF"><a href="#什么是-AOF" class="headerlink" title="什么是 AOF"></a>什么是 AOF</h4><p>AOF 文件 就像是日志，宕机能够恢复。</p>
<h4 id="AOF-三种策略"><a href="#AOF-三种策略" class="headerlink" title="AOF 三种策略"></a>AOF 三种策略</h4><p>always ：写命令刷新到缓冲区，然后每天命令都会写道AOF文件中<br>everysec ： 每秒进行刷新，每秒写道缓冲区再到AOF文件，可能存在宕机丢失1s的命令；高写入量可保护磁盘。<br>no ： 根据操作系统来，不可控，不用管</p>
<h4 id="AOF-重写"><a href="#AOF-重写" class="headerlink" title="AOF 重写"></a>AOF 重写</h4><p>作用：</p>
<p>减少磁盘占用量；<br>加速恢复速度；</p>
<p>两种方式：</p>
<p>bgrewriteaof 命令：</p>
<p>AOF 重写配置：</p>
<p>auto-aof-rewrite-min-size ： AOF 文件重写需要的尺寸<br>auto-aof-rewrite-percentage : AOF 文件增长率</p>
<p>aof_current_size : AOF 当前尺寸（单位：字节）<br>aof_base_size : AOF 上次启动和重写的尺寸（单位：字节）</p>
<p><img data-src="http://tuchuang.xchcloud.cn/AOF%E9%87%8D%E5%86%99%E6%B5%81%E7%A8%8B%20%E5%9B%BE%E5%8D%81%E5%85%AB.png" alt="AOF 重写流程 图 21"></p>
<p>配置说明：</p>
<h3 id="RDB-和-AOF-的抉择"><a href="#RDB-和-AOF-的抉择" class="headerlink" title="RDB 和 AOF 的抉择"></a>RDB 和 AOF 的抉择</h3><p><img data-src="http://tuchuang.xchcloud.cn/%E5%9B%BE%2022.png" alt="图 22"></p>
<h2 id="开发运维常见问题"><a href="#开发运维常见问题" class="headerlink" title="开发运维常见问题"></a>开发运维常见问题</h2><h3 id="fork-操作"><a href="#fork-操作" class="headerlink" title="fork 操作"></a>fork 操作</h3><p>同步操作</p>
<p>与内存量息息相关：内存越大，耗时越长（与机器类型有关）</p>
<p>info:latest_fork_usec : 查持久化的时间</p>
<p>改善 fork ：</p>
<p>1、优先使用物理机或者高效支持fork操作的虚拟化技术<br>2、控制redis实例最大可用内存：maxmemory<br>3、合理配置Linux内存分配策略：vm.overcommit_memery=1<br>4、降低fork频率：例如放宽AOF重写自动触发时机，不必要的全量复制</p>
<h3 id="进程外开销"><a href="#进程外开销" class="headerlink" title="进程外开销"></a>进程外开销</h3><p>1、CPU</p>
<ul>
<li>开销：RDB和AOF文件生成，属于CPU密集型</li>
<li>优化：不做CPU绑定，不和CPU密集型部署</li>
</ul>
<p>2、内存</p>
<ul>
<li>开销：fork内存开销，copy-on-write</li>
<li>优化： echo never &gt; /sys/kernel/mem/transparent_hugepage/enabled</li>
</ul>
<p>3、硬盘</p>
<ul>
<li>开销：AOF和RDB文件写入，可以结合iostst,iotop分析</li>
</ul>
<p>硬盘优化：<br>1、不要和高硬盘负载服务部署一起：存储服务、消息队列服务<br>2、no-appendfsync-on-rewrite = yes<br>3、根据写入量决定磁盘类型：例如ssd</p>
<h3 id="AOF-追加阻塞"><a href="#AOF-追加阻塞" class="headerlink" title="AOF 追加阻塞"></a>AOF 追加阻塞</h3><p>AOF 阻塞定位：</p>
<h2 id="Redis-复制的原理与-优化"><a href="#Redis-复制的原理与-优化" class="headerlink" title="Redis 复制的原理与 优化"></a>Redis 复制的原理与 优化</h2><h3 id="什么是主从复制"><a href="#什么是主从复制" class="headerlink" title="什么是主从复制"></a>什么是主从复制</h3><p>单机有什么问题：机器故障~容量瓶颈，QPS瓶颈</p>
<p>主从复制作用：数据副本，拓展性能。</p>
<p>一个master可以有多个slave<br>一个slave只能有一个master</p>
<h3 id="复制的配置"><a href="#复制的配置" class="headerlink" title="复制的配置"></a>复制的配置</h3><p>命令实现：slaveof ip port<br>取消主从命令：slaveof no one</p>
<p>可以子啊配置中修改添加</p>
<p>slaveof ip port<br>slave-read-only yes : 只读操作</p>
<p>命令方式：无需重启，不便于管理<br>配置方式：统一配置，需要重启</p>
<h3 id="全量复制和部分复制"><a href="#全量复制和部分复制" class="headerlink" title="全量复制和部分复制"></a>全量复制和部分复制</h3><p><img data-src="http://tuchuang.xchcloud.cn/%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6%20%E5%9B%BE%2023.png" alt="全量复制 图 23"></p>
<p>全量复制开销：<br>1、bgsave时间<br>2、RDB文件网络传输时间<br>3、从节点清空数据时间<br>4、从节点加载RDB的时间<br>5、可能的AOF重写时间</p>
<p><img data-src="http://tuchuang.xchcloud.cn/%E9%83%A8%E5%88%86%E5%A4%8D%E5%88%B6%20%E5%9B%BE24.png" alt="部分复制 图 24"></p>
<h3 id="故障处理"><a href="#故障处理" class="headerlink" title="故障处理"></a>故障处理</h3><p>slave 故障</p>
<p>master 故障</p>
<h3 id="开发运维常见问题-1"><a href="#开发运维常见问题-1" class="headerlink" title="开发运维常见问题"></a>开发运维常见问题</h3><p>1、读写分离</p>
<p>把都流量分给 从节点</p>
<p>问题：复制数据的延迟；读到过期的数据，从节点故障</p>
<p>2、主从配置不一致</p>
<p>问题：例如 maxmemory 不一致：丢失数据；例如数据结构优化参数（例如hash-max-ziplist-entries）：内存不一致</p>
<p>3、规避全量复制</p>
<p>问题：第一次全量复制，第一次不可避免，小主节点、低峰；节点运行id不匹配，主节点重启，运行id会变化，导致来一次全量复制，故障转移，例如哨兵或者集群；复制积压缓冲区不足：网络中断，部分复制无法满足，增大复制缓冲区配置rel_backlog_size，网络”增强”。</p>
<p>4、规避复制风暴</p>
<p>问题：单节点复制风暴，主节点重启，多从节点复制：解决：更换复制拓扑结构，如树形结构等；单节点复制风暴：机器宕机后，大量全量复制：解决：主节点分散多机器，或者一个高可用的架构。</p>
<h2 id="Redis-Sentinel"><a href="#Redis-Sentinel" class="headerlink" title="Redis Sentinel"></a>Redis Sentinel</h2><h3 id="主从复制高可用"><a href="#主从复制高可用" class="headerlink" title="主从复制高可用"></a>主从复制高可用</h3><p>备份、分流；出现问题，故障转移~</p>
<p>手动故障转移：</p>
<p>写能力和存储能力的限制：</p>
<h3 id="架构说明"><a href="#架构说明" class="headerlink" title="架构说明"></a>架构说明</h3><p>Redis Sentinel 架构</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图11.png" alt="图23"></p>
<p><img data-src="http://tuchuang.xchcloud.cn/图24.png" alt="故障转移 图24"></p>
<h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><p>1、配置开启主从节点<br>2、配置开启sentinel监控主节点。（sentinel是特殊的redis）<br>3、实际应该多机器<br>4、详细配置节点</p>
<p>主从节点、sentinel的配置说明</p>
<h3 id="客户端链接"><a href="#客户端链接" class="headerlink" title="客户端链接"></a>客户端链接</h3><h3 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h3><p>三个定时任务：<br>1、每10s每个sentinel对master和slave执行info：发现slave节点，确认主从节点。<br>2、每2s每个sentinel通过master节点的channel交换信息（pub/sub）：通过<strong>sentinel</strong>:hello 频道交互，交互对节点的“看法”和自身信息。<br>3、每1s每个sentinel对其他sentinel和redis执行ping。心跳检测</p>
<p>主观下线和客观下线</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图25.png" alt="图25"></p>
<p>领导者选举</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图25.png" alt="图26"></p>
<p>故障转移（sentinel 领导者节点完成）<br><img data-src="http://tuchuang.xchcloud.cn/图27.png" alt="图27"></p>
<p>选择合适的slave节点</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图28.png" alt="图28"></p>
<h3 id="常见开发运维问题"><a href="#常见开发运维问题" class="headerlink" title="常见开发运维问题"></a>常见开发运维问题</h3><p>节点运维：</p>
<p>节点下线：<br>机器下线:过保问题，机器性能问题，节点自身问题</p>
<p>sentinel failover <mastername></mastername></p>
<p>从节点：临时下线还是永久下线，读写分离等情况考虑。</p>
<p>节点上线：<br>主节点：sentinel failover 进行替换<br>从节点：slaveof即可，sentinel节点可以感知<br>sentinel节点：参考其他sentinel节点启动即可</p>
<p>高可用读写分离</p>
<p>从节点作用：<br>副本：高可用基础<br>拓展：读能力</p>
<p>三个“消息”</p>
<ul>
<li>switch-master: 切换主节点（从节点晋升主节点）</li>
<li>convert-to-slave : 切换从节点（原主节点降为从节点）</li>
<li>sdown ： 主管下线</li>
</ul>
<h2 id="Redis-Cluster"><a href="#Redis-Cluster" class="headerlink" title="Redis Cluster"></a>Redis Cluster</h2><h3 id="呼唤集群"><a href="#呼唤集群" class="headerlink" title="呼唤集群"></a>呼唤集群</h3><p>为什么呼唤：1.并发量；2。数据量</p>
<p>配置更强悍的机器</p>
<p>分布式：简单的认为加机器。</p>
<p>集群:规模化需求，并发量：OPS  数据量：“大数据”</p>
<h3 id="数据分布"><a href="#数据分布" class="headerlink" title="数据分布"></a>数据分布</h3><p>顺序分区：</p>
<p>哈希分区：（例如节点取模、一次性哈希分区、虚拟槽分区）</p>
<p>节点取余：hash(key)%nodes    PS：容量变化，会造成数据进行偏移<br>客户端分片：哈希+取余<br>节点伸缩：数据节点关系变化，导致数据迁移<br>迁移数量和添加节点数量有关：建议翻倍扩容</p>
<p>一致性hash：   PS：扩容的话影响很低<br>客户端分片：哈希+顺时针（优化取余）<br>节点伸缩：只影响临近节点，但是还是有数据迁移<br>翻倍伸缩：保证最小迁移数据和负载均衡</p>
<p>虚拟槽分区：<br>预设虚拟槽：每个槽映射一个数据子集，一版比节点数大<br>良好的哈希函数：例如CRC16<br>服务端管理节点、槽数据：例如 Redis Cluster</p>
<p>对比：</p>
<p><img data-src="http://tuchuang.xchcloud.cn/29.png" alt="图29"></p>
<h3 id="搭建集群"><a href="#搭建集群" class="headerlink" title="搭建集群"></a>搭建集群</h3><p>Redis Cluster 架构：节点、meet、指派槽、复制</p>
<p>所有节点共享消息</p>
<p>特性：复制、高可用、分片</p>
<p>Redis Cluster 安装：原生命令安装、官方工具安装<br>配置：<br>开启节点：  配置里 cluster-enabled yes ;cluster-config-file nodes-${port}.conf<br>            Redis-server redis-7000.conf<br>meet （节点之际去哪通信）：cluster meet ip port<br>配置槽 : cluster addslots slot [slot …]<br>主从配置 : cluster replicate node-id</p>
<h2 id="集群伸缩"><a href="#集群伸缩" class="headerlink" title="集群伸缩"></a>集群伸缩</h2><h3 id="伸缩原理"><a href="#伸缩原理" class="headerlink" title="伸缩原理"></a>伸缩原理</h3><p>集群伸缩=槽和数据在节点之间的移动</p>
<p>扩容集群：准备新节点、加入集群、迁移槽和数据</p>
<p>准备新节点：<br>集群模式；配置和其他节点统一；启动后是孤儿节点；</p>
<p>加入集群：<br>作用：为它迁移槽和数据实现扩容；作为从节点负责故障转移<br>redis-trib.rb : 使用 rb 能够避免新节点已经加入了其他集群，造成故障。<br>rb 的工作原理、过程：</p>
<p>迁移槽和数据：</p>
<ul>
<li>槽迁移计划：</li>
<li>迁移数据：</li>
<li>添加从节点：</li>
</ul>
<p>迁移数据：</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图30.png" alt="30"></p>
<p><img data-src="http://tuchuang.xchcloud.cn/31.png" alt="31"></p>
<h3 id="收缩集群"><a href="#收缩集群" class="headerlink" title="收缩集群"></a>收缩集群</h3><p>下线迁移槽；<br>忘记节点；cluster forget {id}<br>关闭节点。</p>
<h3 id="客户端路由"><a href="#客户端路由" class="headerlink" title="客户端路由"></a>客户端路由</h3><p>moved 从定向</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图31.png" alt="图31"></p>
<p><img data-src="http://tuchuang.xchcloud.cn/图32.png" alt="图32"></p>
<p><img data-src="http://tuchuang.xchcloud.cn/图33.png" alt="图33"></p>
<p>ask 重定向</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图34.png" alt="图34"></p>
<p><img data-src="http://tuchuang.xchcloud.cn/图35.png" alt="图35"></p>
<p>moved 和 ask 区别：两者都是客户单重定向；moved：槽已确定迁移；ask：槽还在迁移中。</p>
<p>smart 客户端</p>
<p>实现原理：追求性能。<br>1、从集群中选一个可运行节点，使用cluster slots 初始化槽和节点映射<br>2、将cluster slots 的结果映射到本地，为每一个节点创建JedisPool<br>3、准备执行命令</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图36.png" alt="图36"></p>
<p>使用方法：对应的一个 java 客户端</p>
<p>简单案例、整合到spring、多节点命令实现、如何实现批量操作</p>
<p>批量操作如何让实现：</p>
<p>1、串行mget : for 循环遍历所有key<br>2、串行IO ：在客户端对key进行内聚，根据节点分组，通过pipeline执行。<br>3、并行IO： 同上，但是是并行的执行多个pipeline<br>4、hash_tag ： 对key进行包装，mget（hash_key）</p>
<p>对比：</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图37.png" alt="图37"></p>
<h3 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h3><p>故障发现<br>1、通过ping/pong消息实现故障发现：不需要sentinel<br>2、主观下线和客观下线</p>
<p>主观下线：</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图38.png" alt="图38"></p>
<p>客观下线：</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图39.png" alt="图39"></p>
<p>尝试客观下线：</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图40.png" alt="图40"></p>
<h3 id="故障恢复"><a href="#故障恢复" class="headerlink" title="故障恢复"></a>故障恢复</h3><h4 id="资格检查："><a href="#资格检查：" class="headerlink" title="资格检查："></a>资格检查：</h4><p>每个从节点检查与故障主节点的断线时间；超过cluster-node-timeout * cluster-slave-validity-factor 取消资格；cluster-slave-validity-factor : 默认是10</p>
<h4 id="准备选举时间："><a href="#准备选举时间：" class="headerlink" title="准备选举时间："></a>准备选举时间：</h4><p><img data-src="http://tuchuang.xchcloud.cn/图41.png" alt="图41"></p>
<h4 id="选举投票："><a href="#选举投票：" class="headerlink" title="选举投票："></a>选举投票：</h4><p><img data-src="http://tuchuang.xchcloud.cn/图42.png" alt="图42"></p>
<h4 id="替换主节点："><a href="#替换主节点：" class="headerlink" title="替换主节点："></a>替换主节点：</h4><p><img data-src="http://tuchuang.xchcloud.cn/图43.png" alt="图43"></p>
<h3 id="故障转移演练"><a href="#故障转移演练" class="headerlink" title="故障转移演练"></a>故障转移演练</h3><h3 id="Redis-Cluster-开发运维常见问题"><a href="#Redis-Cluster-开发运维常见问题" class="headerlink" title="Redis Cluster 开发运维常见问题"></a>Redis Cluster 开发运维常见问题</h3><h4 id="集群完整性"><a href="#集群完整性" class="headerlink" title="集群完整性"></a>集群完整性</h4><ul>
<li><p>cluster-require-full-coverage 默认是 yes</p>
</li>
<li><ul>
<li>集群中16384个槽全部可用：保证集群完整性</li>
</ul>
</li>
<li><ul>
<li>节点故障或者正在故障转移：（error）CLUSTERDOWN the cluster is down</li>
</ul>
</li>
<li><p>大多数业务无法容忍，cluster-require-full-coverage 建议设置为no</p>
</li>
</ul>
<h4 id="宽带消耗"><a href="#宽带消耗" class="headerlink" title="宽带消耗"></a>宽带消耗</h4><p>官方建议：不超过1000个节点<br>ping/pong信息<br>不容忽视的宽带消耗</p>
<p>三个方面：<br>消息发送频率：节点发现与与其他节点最后通信时间超过cluster-node-timeout/2时会直接发送ping消息<br>消息数据量：slots 槽数组（2KB空间）和整个集群1/10的状态数据（10个节点状态数据约1KB）<br>节点部署的机器规模：集群分布的机器越多且每台机器划分的节点数越均匀，则集群内整体的可用宽带越高</p>
<p>一个例子：</p>
<ul>
<li>规模：200个节点、20台物理机（每台10个节点）</li>
<li>cluster-node-timeout = 15000 ,ping/pong 宽带为25Mb</li>
<li>cluster-node-timeout=20000,ping/pong宽带低于15Mb</li>
</ul>
<p>优化：</p>
<p>避免“大”集群：避免多业务使用一个集群，大业务可以多集群。<br>cluster-node-timeout: 宽带和故障转移速度的均衡<br>尽量均匀分配到多机器上：保证高可用和宽带</p>
<h4 id="pub-sub-广播"><a href="#pub-sub-广播" class="headerlink" title="pub/sub 广播"></a>pub/sub 广播</h4><p>问题：publish 在集群每个节点广播：加重宽带<br>解决：单独“走”一套Redis Sentinel</p>
<h4 id="数据倾斜"><a href="#数据倾斜" class="headerlink" title="数据倾斜"></a>数据倾斜</h4><ul>
<li>数据倾斜：内存不均匀</li>
</ul>
<p>1、节点和槽分配不均匀<br>redis-trib.rb info ip:port 查看节点、槽、键值分布<br>redis-trib.rb rebalance ip:port 进行均衡（谨慎使用）</p>
<p>2、不同槽对应键值数量差异较大<br>CRC16正常情况下比较均匀<br>可能存在hash_tag<br>cluster countkeysinslot {slot}获取槽对应键值个数</p>
<p>3、包含bigkey<br>bigkey：例如大的字符串、几百万的元素的hash、set等<br>从节点：redis-cli –bigkeys<br>优化：优化数据结构</p>
<p>4、内存相关配置不一致<br>hash-max-ziplist-value、set-max-inset-entries等<br>优化：定期“检查”配置一致性</p>
<ul>
<li>请求倾斜：热点</li>
</ul>
<p>1、热点 key：重要的 key 或者 bigkey<br>优化：<br>避免 bigkey<br>热键不要用 hash__tag<br>当一致性不高时，可以用本地缓存 + MQ</p>
<h4 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h4><p>1、只读链接：集群模式的从节点不接受任何读写请求</p>
<p>重定向到负责槽的主节点<br>readonly命令可以读：连接级别命令</p>
<p>2、读写分离：更佳复杂<br>同样的问题：复制延迟、读取过期数据、从节点故障<br>修改客户端：cluster slaver {nodeId}</p>
<h4 id="数据迁移"><a href="#数据迁移" class="headerlink" title="数据迁移"></a>数据迁移</h4><p>1、官方迁移工具：redis-trib.rb import<br>只能从单机迁移到集群<br>不支持在线迁移：source需要停写<br>不支持断点续传<br>单线程迁移：影响速度</p>
<p>2、在线迁移<br>唯品会：redis-migrate-tool<br>豌豆荚：redis-port</p>
<h4 id="集群-VS-单机"><a href="#集群-VS-单机" class="headerlink" title="集群 VS 单机"></a>集群 VS 单机</h4><p>1、集群限制：key 批量操作支持有限：例如mget、mset必须在一个slot<br>2、Key事务和Lua支持有限：操作的key必须在一个节点上<br>3、key是数据分区的最小粒度：不支持bigkey分区<br>4、不支持多个数据库：集群模式下只有一个db 0<br>5、复制只支持一层：不支持树形复制结构</p>
<p>思考：redis分布式不一定是好的<br>1、redis cluster ：满足容量和性能的拓展性，很多业务“不需要”。<br>大多数时客户端性能会“降低”<br>命令无法跨节点使用：mget、keys、scan、flush、sinter等<br>lua和事务无法跨节点使用<br>客户端维护更复杂：SDK和应用本身消耗（例如更多的连接池）</p>
<p>2、很多场景redis sentinel 已经足够好</p>
<h4 id="集群总结"><a href="#集群总结" class="headerlink" title="集群总结"></a>集群总结</h4><p><img data-src="http://tuchuang.xchcloud.cn/图44.png" alt="图44"></p>
<p><img data-src="http://tuchuang.xchcloud.cn/图45.png" alt="图45"></p>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><h3 id="缓存的使用与设计"><a href="#缓存的使用与设计" class="headerlink" title="缓存的使用与设计"></a>缓存的使用与设计</h3><h4 id="缓存的受益与成本"><a href="#缓存的受益与成本" class="headerlink" title="缓存的受益与成本"></a>缓存的受益与成本</h4><p>受益：<br>1、加速读写<br>2、降低后端负载</p>
<p>成本<br>1、数据不一致性<br>2、代码维护成本：多了一层缓存逻辑<br>3、运维成本</p>
<p>使用场景<br>1、降低后端负载<br>2、加速请求响应 ：优化IO响应时间<br>3、大量写合并为批量写 ：计数器先Redis累加再批量写DB</p>
<h4 id="缓存更新策略"><a href="#缓存更新策略" class="headerlink" title="缓存更新策略"></a>缓存更新策略</h4><p>1、LRU/LFU/FIFO算法剔除：例如maxmemory-policy   一致性最差，维护成本低<br>2、超时剔除：例如expire                         一致性较差，维护成本低<br>3、主动更新：开发控制生命周期                    一致性强，维护成本高</p>
<p>建议：<br>1、低一致性：最大内存和淘汰策略<br>2、高一致性：超时剔除和主动更新结合，最大内存和淘汰策略兜底。</p>
<h4 id="缓存粒度控制"><a href="#缓存粒度控制" class="headerlink" title="缓存粒度控制"></a>缓存粒度控制</h4><p><img data-src="http://tuchuang.xchcloud.cn/图46.png" alt="图46"></p>
<p>控制的三个角度：<br>1、通用性：全量属性最好<br>2、占用空间：部分属性更好<br>3、代码维护、表面上全量属性更好</p>
<h4 id="缓存透彻优化"><a href="#缓存透彻优化" class="headerlink" title="缓存透彻优化"></a>缓存透彻优化</h4><p>问题：大量请求不命中</p>
<p>原因：<br>1、业务代码自身问题<br>2、恶意攻击、爬虫等等</p>
<p>如何发现：</p>
<p>1、业务的相应时间<br>2、业务本身问题<br>3、相关指标：总调用数</p>
<p>解决方法：<br>1、缓存空对象  ？？？？</p>
<ul>
<li>需要更多的键</li>
<li>缓存层和存储层数据“短期”不一致</li>
</ul>
<p>2、布隆过滤器拦截   ？？？？</p>
<h4 id="无底洞问题优化"><a href="#无底洞问题优化" class="headerlink" title="无底洞问题优化"></a>无底洞问题优化</h4><p>问题：加机器性能没能提升反而下降了。（量太大）</p>
<p>问题关键点：<br>更多的机器不等于更高的性能<br>批量接口需求<br>数据增长和水平拓展需求</p>
<p>优化IO方法：<br>1、命令本身优化：慢查询、hgetall bigkey<br>2、减少网络通信次数<br>3、降低接口成本：例如客户端长连接/连接池、NIO等。</p>
<p>4种批量优化的方法：<br>1、串行mget<br>2、串行IO<br>3、并行IO<br>4、hash_tag</p>
<h4 id="缓存雪崩问题"><a href="#缓存雪崩问题" class="headerlink" title="缓存雪崩问题"></a>缓存雪崩问题</h4><h4 id="热点key重建优化"><a href="#热点key重建优化" class="headerlink" title="热点key重建优化"></a>热点key重建优化</h4><p>问题描述：热点key + 较长的重建时间</p>
<p><img data-src="http://tuchuang.xchcloud.cn/图47.png" alt="图47"></p>
<p>三个目标和两个解决：<br>1、三个目标<br>减少重缓存的次数<br>数据尽可能一致<br>减少潜在危险</p>
<p>2、两个解决<br>互斥锁<br><img data-src="http://tuchuang.xchcloud.cn/图48.png" alt="图48"><br>永远不过期<br>缓存层面：没有设置过期时间（没有用expire）<br>功能层面：为每一个value添加逻辑过期时间，单发现超过逻辑过期时间后，会使用单独的线程去构建缓存。<br><img data-src="http://tuchuang.xchcloud.cn/图49.png" alt="图49"></p>
<p><img data-src="http://tuchuang.xchcloud.cn/图50.png" alt="图50"></p>
<h5 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h5><p><img data-src="http://tuchuang.xchcloud.cn/图51.png" alt="图51"><br><img data-src="http://tuchuang.xchcloud.cn/图52.png" alt="图52"></p>
<h2 id="Redis-云平台-Cachcloud"><a href="#Redis-云平台-Cachcloud" class="headerlink" title="Redis 云平台 Cachcloud"></a>Redis 云平台 Cachcloud</h2><h3 id="Redis-规模化运维"><a href="#Redis-规模化运维" class="headerlink" title="Redis 规模化运维"></a>Redis 规模化运维</h3><p>遇到的问题：<br>发布构建繁琐，私搭乱盖<br>节点&amp;机器等运维成本<br>监控报警初级</p>
<p>使用场景：<br>1、全量视频缓存（视频播放API）：跨机房高可用<br>2、消息队列同步（RedisMQ中间件）<br>3、分布式布隆过滤器（百万QPS）<br>4、技术系统：计数（播放值）<br>5、其他：排行榜、社交（直播、实时计算（反作弊）等）</p>
<h4 id="CacheCloud"><a href="#CacheCloud" class="headerlink" title="CacheCloud"></a>CacheCloud</h4><p>1、一键开启 Redis<br>2、机器、应用、实例监控和报警<br>3、客户端：透明使用、性能上报<br>4、可视化运维：配置、扩容、Failover、机器/应用/实例上下线<br>5、已经存在redis直接接入和数据迁移</p>
<h3 id="快速构建"><a href="#快速构建" class="headerlink" title="快速构建"></a>快速构建</h3><p>略</p>
<h3 id="机器部署"><a href="#机器部署" class="headerlink" title="机器部署"></a>机器部署</h3><p>略</p>
<h3 id="应用接入"><a href="#应用接入" class="headerlink" title="应用接入"></a>应用接入</h3><p>略</p>
<h3 id="用户功能"><a href="#用户功能" class="headerlink" title="用户功能"></a>用户功能</h3><p>略</p>
<h3 id="运维功能"><a href="#运维功能" class="headerlink" title="运维功能"></a>运维功能</h3><p>略</p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>1、Redis 初识：单机安装部署（版本选择），边界（使用场景）<br>2、API理解和使用：单线程、5种数据结构使用和选择<br>3、Redis客户端使用：jedis、redis-py等，客户端很“简单”。<br>4、瑞士军刀Redis：慢查询、pipeline、发布订阅、bitmap等<br>5、Redis 持久化：RDB和AOF的优缺点和最佳实践<br>6、Redis复制：配置方法、全量和部分复制、常见运维<br>7、Redis Sentinel ： 高可用、架构、“新”的客户端、基本原理<br>8、Redis Cluster ： 数据分布、架构、安装部署、扩容、客户端、常见问题<br>9、缓存设计与优化：粒度、更新策略、无底洞问题、穿透、雪崩、热点key<br>10、CacheCloud ： 平台化Redis开发运维工具</p>

    </div>

    
    
    
        <div class="reward-container">
  <div>喜欢这篇文章？打赏一下作者吧！</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.png" alt="超超 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.png" alt="超超 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>超超
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://xchcloud.cn/Redis-入门笔记/" title="Redis-入门笔记">https://xchcloud.cn/Redis-入门笔记/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/jenkins-cli/" rel="prev" title="jenkins-cli">
      <i class="fa fa-chevron-left"></i> jenkins-cli
    </a></div>
      <div class="post-nav-item">
    <a href="/linux-shell-复盘/" rel="next" title="linux-shell-复盘">
      linux-shell-复盘 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#八个特性"><span class="nav-text">八个特性</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#速度快"><span class="nav-text">速度快</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久化"><span class="nav-text">持久化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#多种数据结构"><span class="nav-text">多种数据结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#支持多种编程语言"><span class="nav-text">支持多种编程语言</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#功能丰富"><span class="nav-text">功能丰富</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#简单"><span class="nav-text">简单</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主从复制"><span class="nav-text">主从复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#高可用、分布式"><span class="nav-text">高可用、分布式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用场景"><span class="nav-text">应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存系统"><span class="nav-text">缓存系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#计数器"><span class="nav-text">计数器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息队列系统"><span class="nav-text">消息队列系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#排行榜"><span class="nav-text">排行榜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#社交网络"><span class="nav-text">社交网络</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实时系统"><span class="nav-text">实时系统</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-安装"><span class="nav-text">redis 安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通用命令"><span class="nav-text">通用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#通用命令-1"><span class="nav-text">通用命令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时间复杂度"><span class="nav-text">时间复杂度</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据结构和内部编码"><span class="nav-text">数据结构和内部编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#单线程"><span class="nav-text">单线程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字符串键值结构"><span class="nav-text">字符串键值结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字符串总结"><span class="nav-text">字符串总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#redis-Api-的使用和理解"><span class="nav-text">redis Api 的使用和理解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实战"><span class="nav-text">实战</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#redis-客户端"><span class="nav-text">redis 客户端</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#java-客户端-：Jedis"><span class="nav-text">java 客户端 ：Jedis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#python-客户端-：redis-py"><span class="nav-text">python 客户端 ：redis-py</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#瑞士军刀-redis"><span class="nav-text">瑞士军刀 redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#慢查询"><span class="nav-text">慢查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#生命周期"><span class="nav-text">生命周期</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#两个配置"><span class="nav-text">两个配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三个命令"><span class="nav-text">三个命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运维经验"><span class="nav-text">运维经验</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pipeline"><span class="nav-text">pipeline</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是流水线"><span class="nav-text">什么是流水线</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#与原生操作对比"><span class="nav-text">与原生操作对比</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端实现"><span class="nav-text">客户端实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用建议"><span class="nav-text">使用建议</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发布订阅"><span class="nav-text">发布订阅</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#角色"><span class="nav-text">角色</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模型"><span class="nav-text">模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#API"><span class="nav-text">API</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息队列"><span class="nav-text">消息队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发布订阅总结"><span class="nav-text">发布订阅总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Bitmap"><span class="nav-text">Bitmap</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#位图"><span class="nav-text">位图</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#相关命令"><span class="nav-text">相关命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#独立用户统计"><span class="nav-text">独立用户统计</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用经验"><span class="nav-text">使用经验</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HyperlogLog"><span class="nav-text">HyperlogLog</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#新的数据结构？"><span class="nav-text">新的数据结构？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内存消耗"><span class="nav-text">内存消耗</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#三个命令-1"><span class="nav-text">三个命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用经验-1"><span class="nav-text">使用经验</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GEO"><span class="nav-text">GEO</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#是什么？"><span class="nav-text">是什么？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#相关命令-1"><span class="nav-text">相关命令</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#相关说明"><span class="nav-text">相关说明</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#持久化的取舍和选择"><span class="nav-text">持久化的取舍和选择</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#持续化作用"><span class="nav-text">持续化作用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是持久化"><span class="nav-text">什么是持久化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#持久化的实现方式"><span class="nav-text">持久化的实现方式</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RDB"><span class="nav-text">RDB</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是-RDB"><span class="nav-text">什么是 RDB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#触发机制-主要三种方式"><span class="nav-text">触发机制-主要三种方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#触发机制-不容忽视方式"><span class="nav-text">触发机制-不容忽视方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RDB-总结"><span class="nav-text">RDB 总结</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#redis-配置文件说明"><span class="nav-text">redis 配置文件说明</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOF"><span class="nav-text">AOF</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RDB-现存的问题"><span class="nav-text">RDB 现存的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是-AOF"><span class="nav-text">什么是 AOF</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOF-三种策略"><span class="nav-text">AOF 三种策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOF-重写"><span class="nav-text">AOF 重写</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RDB-和-AOF-的抉择"><span class="nav-text">RDB 和 AOF 的抉择</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#开发运维常见问题"><span class="nav-text">开发运维常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#fork-操作"><span class="nav-text">fork 操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#进程外开销"><span class="nav-text">进程外开销</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOF-追加阻塞"><span class="nav-text">AOF 追加阻塞</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-复制的原理与-优化"><span class="nav-text">Redis 复制的原理与 优化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是主从复制"><span class="nav-text">什么是主从复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制的配置"><span class="nav-text">复制的配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全量复制和部分复制"><span class="nav-text">全量复制和部分复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#故障处理"><span class="nav-text">故障处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开发运维常见问题-1"><span class="nav-text">开发运维常见问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Sentinel"><span class="nav-text">Redis Sentinel</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主从复制高可用"><span class="nav-text">主从复制高可用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#架构说明"><span class="nav-text">架构说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装配置"><span class="nav-text">安装配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端链接"><span class="nav-text">客户端链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#实现原理"><span class="nav-text">实现原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见开发运维问题"><span class="nav-text">常见开发运维问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Cluster"><span class="nav-text">Redis Cluster</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#呼唤集群"><span class="nav-text">呼唤集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据分布"><span class="nav-text">数据分布</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#搭建集群"><span class="nav-text">搭建集群</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群伸缩"><span class="nav-text">集群伸缩</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#伸缩原理"><span class="nav-text">伸缩原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#收缩集群"><span class="nav-text">收缩集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端路由"><span class="nav-text">客户端路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#故障转移"><span class="nav-text">故障转移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#故障恢复"><span class="nav-text">故障恢复</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#资格检查："><span class="nav-text">资格检查：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#准备选举时间："><span class="nav-text">准备选举时间：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#选举投票："><span class="nav-text">选举投票：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#替换主节点："><span class="nav-text">替换主节点：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#故障转移演练"><span class="nav-text">故障转移演练</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-Cluster-开发运维常见问题"><span class="nav-text">Redis Cluster 开发运维常见问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#集群完整性"><span class="nav-text">集群完整性</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#宽带消耗"><span class="nav-text">宽带消耗</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pub-sub-广播"><span class="nav-text">pub/sub 广播</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据倾斜"><span class="nav-text">数据倾斜</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#读写分离"><span class="nav-text">读写分离</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据迁移"><span class="nav-text">数据迁移</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群-VS-单机"><span class="nav-text">集群 VS 单机</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群总结"><span class="nav-text">集群总结</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#缓存"><span class="nav-text">缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#缓存的使用与设计"><span class="nav-text">缓存的使用与设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存的受益与成本"><span class="nav-text">缓存的受益与成本</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存更新策略"><span class="nav-text">缓存更新策略</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存粒度控制"><span class="nav-text">缓存粒度控制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存透彻优化"><span class="nav-text">缓存透彻优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#无底洞问题优化"><span class="nav-text">无底洞问题优化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#缓存雪崩问题"><span class="nav-text">缓存雪崩问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#热点key重建优化"><span class="nav-text">热点key重建优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#总结"><span class="nav-text">总结</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-云平台-Cachcloud"><span class="nav-text">Redis 云平台 Cachcloud</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis-规模化运维"><span class="nav-text">Redis 规模化运维</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#CacheCloud"><span class="nav-text">CacheCloud</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#快速构建"><span class="nav-text">快速构建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#机器部署"><span class="nav-text">机器部署</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用接入"><span class="nav-text">应用接入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#用户功能"><span class="nav-text">用户功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#运维功能"><span class="nav-text">运维功能</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结-1"><span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="超超"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">超超</p>
  <div class="site-description" itemprop="description">那天早上雾散了，不止早上、不止雾。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">139</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">120</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/lhc0101" title="Github → https://github.com/lhc0101" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>Github</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://gitee.com/lhc0101" title="Gitee → https://gitee.com/lhc0101" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>Gitee</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=qJmcmp_akJ6ZmZHo2dmGy8fF" title="E-mail → http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=qJmcmp_akJ6ZmZHo2dmGy8fF" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://xchcloud.cn" title="Chaoz → http://xchcloud.cn"><i class="Blog fa-fw"></i>Chaoz</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="http://xchcloud.cn" title="http://xchcloud.cn">Chaoz</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://Li-rr.github.io" title="https://Li-rr.github.io" rel="noopener" target="_blank">LRR</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">超超</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">594k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">9:01</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
<script src="/js/utils.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  <script src="/js/local-search.js"></script>












  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : true,
      notify     : true,
      appId      : '8nK1L3qHWfgqbq9MB9ecvuAL-gzGzoHsz',
      appKey     : 'DB0iOmS4cyHd91d0maynMjTC',
      placeholder: "填写正确的邮箱地址能接收到邮件提醒；直接输入QQ号也能收到邮件哦~",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
